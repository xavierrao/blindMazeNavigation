<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blind Crown Quest - Lobby</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <!-- Room selection and creation page -->
    <div id="room-container" class="active-page">
        <div id="room-selection">
            <h1>Blind Crown Quest</h1>
            <button id="create-room" class="fantasy-button">Forge a New Quest</button>
            <div class="memory-toggle-container">
                <label for="memory-toggle-create">Memory Mode (Logs clear each round):</label>
                <input type="checkbox" id="memory-toggle-create">
            </div>
            <div class="memory-toggle-container">
                <label for="random-start-toggle-create">Random Start Space:</label>
                <input type="checkbox" id="random-start-toggle-create">
            </div>
            <input type="text" id="room-id" placeholder="Enter Quest Scroll ID">
            <button id="join-room" class="fantasy-button">Join the Quest</button>
            <button id="back-to-name" class="fantasy-button">Back to Name</button>
        </div>
        <div id="room-id-display" style="display: none;"></div>
    </div>

    <!-- Loading indicator -->
    <div id="loading-indicator" style="display: none;" class="active-page">Crafting Quest...</div>

    <!-- Game Footer - Add before closing </body> tag -->
    <footer class="game-footer">
        <div class="footer-content">
            <div class="footer-section">
                <span>© 2025 Blind Crown Quest</span>
            </div>

            <span class="footer-divider">•</span>

            <div class="footer-section">
                <svg class="github-icon" viewBox="0 0 16 16" fill="#d4a017" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
                </svg>
                <a href="https://github.com/yourusername/blind-crown-quest" target="_blank"
                    rel="noopener noreferrer">GitHub</a>
            </div>

            <span class="footer-divider">•</span>

            <div class="footer-section">
                <a href="/faq" target="_blank">FAQ</a>
            </div>

            <span class="footer-divider">•</span>

            <div class="footer-section">
                <span>Version Beta 1.1</span>
            </div>
        </div>
    </footer>

    <script>
        const socket = io();
        const playerName = localStorage.getItem('playerName');

        // Redirect if no name
        if (!playerName) {
            window.location.href = '/';
        }

        document.getElementById('back-to-name').addEventListener('click', () => {
            window.location.href = '/';
        });

        document.getElementById('create-room').addEventListener('click', () => {
            console.log('Create room button clicked');
            document.getElementById('room-selection').style.display = 'none';
            document.getElementById('loading-indicator').style.display = 'block';

            const memoryMode = document.getElementById('memory-toggle-create').checked;
            const randomStartSpace = document.getElementById('random-start-toggle-create').checked;

            console.log('Emitting create event with:', { memoryMode, randomStartSpace, name: playerName });

            socket.emit('create', { memoryMode, randomStartSpace, name: playerName }, response => {
                console.log('Create response received:', response);

                if (!response) {
                    console.error('No response received from server');
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('room-selection').style.display = 'block';
                    alert('Error: No response from server. Check console for details.');
                    return;
                }

                if (response.error) {
                    console.error('Error creating room:', response.error);
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('room-selection').style.display = 'block';
                    alert(`Error creating room: ${response.error}`);
                    return;
                }

                console.log('Room created successfully:', response.roomId, response.playerId);
                localStorage.setItem('playerId', response.playerId);
                localStorage.setItem('roomId', response.roomId);

                document.getElementById('room-id-display').innerHTML = `
                    <p>Quest Scroll ID: ${response.roomId} (Share with others to join)</p>
                    <button id="copy-room-id" class="fantasy-button copy-button">Copy Scroll ID</button>
                    <button id="continue-game" class="fantasy-button">Continue to Quest</button>
                `;
                document.getElementById('room-id-display').style.display = 'block';
                document.getElementById('loading-indicator').style.display = 'none';

                document.getElementById('copy-room-id').addEventListener('click', () => {
                    navigator.clipboard.writeText(response.roomId).then(() => {
                        document.getElementById('copy-room-id').innerText = 'Copied!';
                        setTimeout(() => document.getElementById('copy-room-id').innerText = 'Copy Scroll ID', 2000);
                    });
                });

                document.getElementById('continue-game').addEventListener('click', () => {
                    console.log('Navigating to game:', response.roomId);
                    window.location.href = `/game/${response.roomId}`;
                });
            });
        });

        document.getElementById('join-room').addEventListener('click', () => {
            const roomId = document.getElementById('room-id').value.trim();
            if (!roomId) {
                alert('Please enter a Quest Scroll ID');
                return;
            }

            document.getElementById('room-selection').style.display = 'none';
            document.getElementById('loading-indicator').style.display = 'block';

            socket.emit('join', { roomId, name: playerName }, response => {
                if (response.error) {
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('room-selection').style.display = 'block';
                    alert(response.error);
                    return;
                }

                localStorage.setItem('playerId', response.playerId);
                localStorage.setItem('roomId', roomId);

                document.getElementById('room-id-display').innerHTML = `
                    <p>Joined Quest: ${roomId}</p>
                    <button id="continue-game" class="fantasy-button">Continue to Quest</button>
                `;
                document.getElementById('room-id-display').style.display = 'block';
                document.getElementById('loading-indicator').style.display = 'none';

                document.getElementById('continue-game').addEventListener('click', () => {
                    window.location.href = `/game/${roomId}`;
                });
            });
        });
    </script>
</body>

</html>